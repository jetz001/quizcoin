<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizCoin Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .login-card {
            max-width: 500px;
            margin: 50px auto;
            text-align: center;
        }

        .metamask-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #f6851b, #e2761b);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-metamask {
            background: linear-gradient(135deg, #f6851b 0%, #e2761b 100%);
            color: white;
            font-size: 16px;
        }

        .btn-metamask:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(246, 133, 27, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 152, 0, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .config-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .config-item h4 {
            margin-bottom: 5px;
            color: #333;
        }

        .config-item p {
            font-size: 1.2rem;
            font-weight: 600;
            color: #667eea;
        }

        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .status {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .status.loading {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .log-container {
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .wallet-info {
            background: #e8f4fd;
            border: 1px solid #b8daff;
            color: #004085;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .wallet-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .wallet-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f6851b, #e2761b);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .admin-badge {
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .access-denied {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        .hidden {
            display: none;
        }

        .logout-btn {
            margin-left: 15px;
        }

        .network-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .config-grid,
            .actions {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }

            .wallet-info {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .wallet-details {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎮 QuizCoin Admin Dashboard</h1>
            <p>Question Generation & Blockchain Management</p>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="card login-card">
            <div class="metamask-logo">🦊</div>
            <h2 style="margin-bottom: 20px;">Connect with MetaMask</h2>
            <p style="margin-bottom: 20px; color: #666;">Connect your MetaMask wallet to access the admin panel</p>
            
            <button onclick="connectMetaMask()" id="connectBtn" class="btn btn-metamask" style="width: 100%; margin-bottom: 15px;">
                🦊 Connect MetaMask
            </button>
            
            <div style="font-size: 12px; color: #888; margin-top: 15px;">
                <strong>Authorized Admin:</strong><br>
                <code style="background: #f5f5f5; padding: 2px 6px; border-radius: 4px;">0x91464947C61570Ad8095eBd701d6fF57722CE483</code>
            </div>
            
            <div id="loginStatus" class="status hidden"></div>
        </div>

        <!-- Access Denied Section -->
        <div id="accessDeniedSection" class="card login-card hidden">
            <h2 style="color: #721c24; margin-bottom: 20px;">🚫 Access Denied</h2>
            <div class="access-denied">
                <p><strong>Unauthorized Wallet Address</strong></p>
                <p style="margin: 10px 0;">Connected: <code id="connectedAddress"></code></p>
                <p style="margin: 10px 0;">Required: <code>0x91464947C61570Ad8095eBd701d6fF57722CE483</code></p>
                <p style="margin-top: 15px; color: #856404;">Please connect with the authorized admin wallet to access this dashboard.</p>
            </div>
            <button onclick="connectMetaMask()" class="btn btn-warning" style="width: 100%; margin-top: 15px;">
                🔄 Try Again
            </button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="hidden">
            <div class="wallet-info">
                <div class="wallet-details">
                    <div class="wallet-avatar">A</div>
                    <div>
                        <div>
                            <span class="network-indicator"></span>
                            <strong>Connected:</strong> <span id="walletAddress"></span>
                            <span class="admin-badge">ADMIN</span>
                        </div>
                        <div style="font-size: 12px; margin-top: 4px;">
                            <strong>Network:</strong> <span id="networkName"></span> | 
                            <strong>Chain ID:</strong> <span id="chainId"></span>
                        </div>
                    </div>
                </div>
                <button onclick="disconnect()" class="btn btn-danger logout-btn">🚪 Disconnect</button>
            </div>

            <!-- Current Configuration -->
            <div class="card">
                <h3 style="margin-bottom: 20px;">⚙️ Current Configuration</h3>
                <div id="configGrid" class="config-grid">
                    <!-- Will be populated by JavaScript -->
                </div>
                <button onclick="refreshConfig()" class="btn btn-primary">🔄 Refresh Config</button>
            </div>

            <!-- Actions -->
            <div class="card">
                <h3 style="margin-bottom: 20px;">🎯 Actions</h3>
                <div class="actions">
                    <button onclick="generateBatch()" id="generateBtn" class="btn btn-success">
                        📝 Generate New Batch
                    </button>
                    <button onclick="generateAndCommit()" id="generateCommitBtn" class="btn btn-warning">
                        🚀 Generate & Commit
                    </button>
                    <button onclick="showCommitModal()" class="btn btn-primary">
                        🔗 Commit Existing Batch
                    </button>
                    <button onclick="viewBatches()" class="btn btn-primary">
                        📊 View All Batches
                    </button>
                </div>
            </div>

            <!-- Status & Logs -->
            <div class="card">
                <h3 style="margin-bottom: 20px;">📋 Status & Logs</h3>
                <div id="statusContainer"></div>
                <div class="log-container" id="logContainer">
Waiting for actions...
                </div>
                <button onclick="clearLogs()" class="btn btn-danger" style="margin-top: 10px;">
                    🗑️ Clear Logs
                </button>
            </div>

            <!-- Batches Table -->
            <div id="batchesSection" class="card hidden">
                <h3 style="margin-bottom: 20px;">📊 Batch History</h3>
                <div id="batchesContainer">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Commit Modal -->
        <div id="commitModal" class="card login-card hidden">
            <h3 style="text-align: center; margin-bottom: 20px;">🔗 Commit Batch</h3>
            <div class="form-group">
                <label for="batchIdInput">Batch ID:</label>
                <input type="text" id="batchIdInput" class="form-control" placeholder="Enter batch ID...">
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="commitBatch()" class="btn btn-success" style="flex: 1;">
                    ✅ Commit Batch
                </button>
                <button onclick="hideCommitModal()" class="btn btn-danger" style="flex: 1;">
                    ❌ Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        const AUTHORIZED_ADMIN = '0x91464947C61570Ad8095eBd701d6fF57722CE483';
        const BSC_TESTNET_CHAIN_ID = '0x61'; // 97 in decimal

        let isLoggedIn = false;
        let currentAccount = null;
        let web3Provider = null;

        // Check if MetaMask is installed
        function checkMetaMask() {
            if (typeof window.ethereum === 'undefined') {
                showLoginStatus('MetaMask is not installed. Please install MetaMask first.', 'error');
                return false;
            }
            return true;
        }

        // Connect MetaMask
        async function connectMetaMask() {
            if (!checkMetaMask()) return;

            const connectBtn = document.getElementById('connectBtn');
            connectBtn.disabled = true;
            connectBtn.textContent = '🔄 Connecting...';

            try {
                showLoginStatus('Connecting to MetaMask...', 'loading');

                // Request account access
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (accounts.length === 0) {
                    throw new Error('No accounts found');
                }

                currentAccount = accounts[0];
                
                // Check if connected account is authorized
                if (currentAccount.toLowerCase() !== AUTHORIZED_ADMIN.toLowerCase()) {
                    showAccessDenied(currentAccount);
                    return;
                }

                // Switch to BSC Testnet if not already
                await switchToBSCTestnet();

                // Get network info
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const networkName = getNetworkName(chainId);

                showLoginStatus('Connected successfully!', 'success');
                
                setTimeout(() => {
                    isLoggedIn = true;
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('accessDeniedSection').classList.add('hidden');
                    document.getElementById('dashboardSection').classList.remove('hidden');
                    
                    document.getElementById('walletAddress').textContent = formatAddress(currentAccount);
                    document.getElementById('networkName').textContent = networkName;
                    document.getElementById('chainId').textContent = parseInt(chainId, 16);
                    
                    setupEventListeners();
                    refreshConfig();
                    addLog('🎉 MetaMask connected successfully as authorized admin');
                }, 1000);

            } catch (error) {
                console.error('Connection error:', error);
                if (error.code === 4001) {
                    showLoginStatus('Connection rejected by user', 'error');
                } else {
                    showLoginStatus(`Connection failed: ${error.message}`, 'error');
                }
            } finally {
                connectBtn.disabled = false;
                connectBtn.textContent = '🦊 Connect MetaMask';
            }
        }

        // Switch to BSC Testnet
        async function switchToBSCTestnet() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: BSC_TESTNET_CHAIN_ID }],
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    // Chain not added, add it
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: BSC_TESTNET_CHAIN_ID,
                            chainName: 'BSC Testnet',
                            nativeCurrency: {
                                name: 'BNB',
                                symbol: 'BNB',
                                decimals: 18
                            },
                            rpcUrls: ['https://data-seed-prebsc-1-s1.binance.org:8545/'],
                            blockExplorerUrls: ['https://testnet.bscscan.com/']
                        }]
                    });
                } else {
                    throw switchError;
                }
            }
        }

        // Setup event listeners for MetaMask
        function setupEventListeners() {
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', handleChainChanged);
                window.ethereum.on('disconnect', handleDisconnect);
            }
        }

        function handleAccountsChanged(accounts) {
            if (accounts.length === 0 || accounts[0].toLowerCase() !== AUTHORIZED_ADMIN.toLowerCase()) {
                addLog('⚠️ Account changed to unauthorized wallet', 'error');
                disconnect();
            } else {
                currentAccount = accounts[0];
                document.getElementById('walletAddress').textContent = formatAddress(currentAccount);
                addLog('✅ Account changed but still authorized');
            }
        }

        function handleChainChanged(chainId) {
            const networkName = getNetworkName(chainId);
            document.getElementById('networkName').textContent = networkName;
            document.getElementById('chainId').textContent = parseInt(chainId, 16);
            addLog(`🔄 Network changed to: ${networkName}`);
        }

        function handleDisconnect() {
            addLog('⚠️ MetaMask disconnected');
            disconnect();
        }

        function showAccessDenied(connectedAddress) {
            document.getElementById('connectedAddress').textContent = connectedAddress;
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('accessDeniedSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            
            connectBtn.disabled = false;
            connectBtn.textContent = '🦊 Connect MetaMask';
        }

        function disconnect() {
            isLoggedIn = false;
            currentAccount = null;
            web3Provider = null;
            
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('accessDeniedSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            
            clearLogs();
            addLog('🚪 Disconnected from MetaMask');
        }

        function formatAddress(address) {
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        function getNetworkName(chainId) {
            const networks = {
                '0x1': 'Ethereum Mainnet',
                '0x3': 'Ropsten Testnet',
                '0x4': 'Rinkeby Testnet',
                '0x5': 'Goerli Testnet',
                '0x38': 'BSC Mainnet',
                '0x61': 'BSC Testnet',
                '0x89': 'Polygon Mainnet',
                '0x13881': 'Polygon Mumbai'
            };
            return networks[chainId] || `Unknown (${parseInt(chainId, 16)})`;
        }

        function showLoginStatus(message, type) {
            const status = document.getElementById('loginStatus');
            status.textContent = message;
            status.className = `status ${type}`;
            status.classList.remove('hidden');
        }

        // API Calls (same as before)
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || `HTTP ${response.status}`);
                }

                return result;
            } catch (error) {
                throw new Error(`API Error: ${error.message}`);
            }
        }

        // Configuration (same as before)
        async function refreshConfig() {
            try {
                addLog('🔄 Fetching current configuration...');
                const result = await apiCall('/admin/config');
                displayConfig(result.config);
                addLog('✅ Configuration loaded successfully');
            } catch (error) {
                addLog(`❌ Failed to load configuration: ${error.message}`, 'error');
                showStatus('Failed to load configuration', 'error');
            }
        }

        function displayConfig(config) {
            const configGrid = document.getElementById('configGrid');
            configGrid.innerHTML = '';

            const configItems = [
                { key: 'TOTAL_QUESTIONS', label: 'Total Questions', value: config.TOTAL_QUESTIONS },
                { key: 'SUB_BATCH_SIZE', label: 'Sub-batch Size', value: config.SUB_BATCH_SIZE },
                { key: 'SUBMIT_LEAVES', label: 'Submit Leaves', value: config.SUBMIT_LEAVES ? 'Yes' : 'No' },
                { key: 'SUBMIT_CHUNK_SIZE', label: 'Chunk Size', value: config.SUBMIT_CHUNK_SIZE },
                { key: 'SUB_BATCH_DELAY', label: 'Sub-batch Delay', value: `${config.SUB_BATCH_DELAY}s` },
                { key: 'TX_DELAY', label: 'TX Delay', value: `${config.TX_DELAY}s` }
            ];

            configItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'config-item';
                div.innerHTML = `
                    <h4>${item.label}</h4>
                    <p>${item.value}</p>
                `;
                configGrid.appendChild(div);
            });
        }

        // Actions (same as before)
        async function generateBatch() {
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.textContent = '🔄 Generating...';

            try {
                addLog('🚀 Starting batch generation...');
                showStatus('Generating new batch...', 'loading');

                const result = await apiCall('/admin/generate-batch', 'POST');
                
                addLog(`✅ Batch generated successfully! ID: ${result.batchId}`);
                addLog(`📊 Total questions created: ${result.totalCreated}`);
                showStatus(`Batch ${result.batchId} generated successfully!`, 'success');
                
            } catch (error) {
                addLog(`❌ Batch generation failed: ${error.message}`, 'error');
                showStatus('Batch generation failed', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = '📝 Generate New Batch';
            }
        }

        async function generateAndCommit() {
            const btn = document.getElementById('generateCommitBtn');
            btn.disabled = true;
            btn.textContent = '🔄 Processing...';

            try {
                addLog('🚀 Starting full batch process (generate + commit)...');
                showStatus('Generating and committing batch...', 'loading');

                const result = await apiCall('/admin/generate-and-commit', 'POST');
                
                addLog(`✅ Full process completed! Batch ID: ${result.generationResult.batchId}`);
                addLog(`📊 Questions created: ${result.generationResult.totalCreated}`);
                addLog(`🌳 Merkle root: ${result.root}`);
                addLog(`🔗 On-chain: ${result.onChain ? 'Yes' : 'No'}`);
                
                if (result.txs && result.txs.length > 0) {
                    addLog(`📝 Transaction(s): ${result.txs.join(', ')}`);
                }
                
                showStatus(`Batch ${result.generationResult.batchId} generated and committed successfully!`, 'success');
                
            } catch (error) {
                addLog(`❌ Full process failed: ${error.message}`, 'error');
                showStatus('Generate and commit failed', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = '🚀 Generate & Commit';
            }
        }

        function showCommitModal() {
            document.getElementById('commitModal').classList.remove('hidden');
        }

        function hideCommitModal() {
            document.getElementById('commitModal').classList.add('hidden');
            document.getElementById('batchIdInput').value = '';
        }

        async function commitBatch() {
            const batchId = document.getElementById('batchIdInput').value.trim();
            if (!batchId) {
                alert('Please enter a batch ID');
                return;
            }

            try {
                addLog(`🔗 Committing batch ${batchId}...`);
                showStatus('Committing batch to blockchain...', 'loading');

                const result = await apiCall('/admin/commit-batch', 'POST', { batchId });
                
                addLog(`✅ Batch ${batchId} committed successfully!`);
                addLog(`🌳 Merkle root: ${result.root}`);
                addLog(`🔗 On-chain: ${result.onChain ? 'Yes' : 'No'}`);
                
                if (result.txs && result.txs.length > 0) {
                    addLog(`📝 Transaction(s): ${result.txs.join(', ')}`);
                }
                
                showStatus(`Batch ${batchId} committed successfully!`, 'success');
                hideCommitModal();
                
            } catch (error) {
                addLog(`❌ Batch commit failed: ${error.message}`, 'error');
                showStatus('Batch commit failed', 'error');
            }
        }

        async function viewBatches() {
            const section = document.getElementById('batchesSection');
            const container = document.getElementById('batchesContainer');

            try {
                addLog('📊 Fetching batch history...');
                const result = await apiCall('/admin/batches');
                
                container.innerHTML = '';
                
                if (result.batches && result.batches.length > 0) {
                    const table = document.createElement('div');
                    table.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 10px; border: 1px solid #ddd;">Batch ID</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Status</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Questions</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Created</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Root</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.batches.map(batch => `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${batch.batchId}</td>
                                                                        <td style="padding: 10px; border: 1px solid #ddd;">
                                                                            <span style="padding: 4px 8px; border-radius: 4px; background: ${getStatusColor(batch.status)}; color: #fff;">
                                                                                ${batch.status}
                                                                            </span>
                                                                        </td>
                                                                        <td style="padding: 10px; border: 1px solid #ddd;">${batch.totalQuestions}</td>
                                                                        <td style="padding: 10px; border: 1px solid #ddd;">${batch.createdAt ? new Date(batch.createdAt).toLocaleString() : ''}</td>
                                                                        <td style="padding: 10px; border: 1px solid #ddd;">${batch.root || ''}</td>
                                                                    </tr>
                                                                `).join('')}
                                                            </tbody>
                                                        </table>
                                                    `;
                                                    container.appendChild(table);
                                                } else {
                                                    container.innerHTML = '<div style="color: #888; text-align: center;">No batches found.</div>';
                                                }
                                                section.classList.remove('hidden');
                                                addLog('✅ Batch history loaded');
                                            } catch (error) {
                                                addLog(`❌ Failed to fetch batches: ${error.message}`, 'error');
                                                showStatus('Failed to fetch batches', 'error');
                                            }
                                        }